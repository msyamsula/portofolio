apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: general-vs
  namespace: default
spec:
  # The host(s) to apply the routing rules to. 
  # This must match the host defined in the Gateway or a service name.
  hosts:
    - "*"
    - "url-shortener" # Matches the service name for internal mesh traffic
  
  # The Gateway(s) this VirtualService is bound to.
  # This makes the rules apply to external traffic coming through the ingress gateway.
  gateways:
    - url-shortener-gateway # The Gateway defined in your previous request
    # - mesh # Applies rules to internal service-to-service traffic
  
  # The routing rules. Istio processes these in order.
  http:
    # 1. Header-Based Routing (Canary for specific users)
    - match:
      - headers:
          user-agent:
            exact: "mobile-app"
      route:
      - destination:
          host: url-shortener # Kubernetes Service Name
          subset: v2         # Istio DestinationRule subset
        weight: 100
      
    # 2. URI Prefix Matching (Routing a specific path to a separate service)
    - match:
      - uri:
          prefix: "/"
      route:
      - destination:
          host: url-shortener # Route to a completely different service
          port:
            number: 10000
    
    # 3. Default Traffic Split (A/B Testing or Canary Rollout)
    - route:
      - destination:
          host: url-shortener
          subset: v1
        weight: 90 # 90% of default traffic goes to v1
      - destination:
          host: url-shortener
          subset: v2
        weight: 10 # 10% of default traffic goes to v2