# Stage 1: Build
FROM node:20-alpine AS build

# Set working directory
WORKDIR /app

# Copy package.json and package-lock.json (or yarn.lock)
COPY package*.json ./

# Copy source code
COPY tsconfig.json ./
COPY src ./src

# Install dev and prod dependencies
RUN npm install

# Compile TypeScript to ESM JS
RUN npx tsc

# Stage 2: Production image
FROM node:20-alpine AS prod

WORKDIR /app

# package*.json and node modules
COPY --from=build /app/package*.json ./

RUN npm install --omit=dev

# Copy compiled JS from build stage
COPY --from=build /app/dist ./dist

# Expose port (adjust if needed)
EXPOSE 12000

# Run the compiled JS
CMD ["node", "dist/main.js"]
